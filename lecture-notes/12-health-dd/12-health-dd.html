<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Lecture 12</title>
    <meta charset="utf-8" />
    <meta name="author" content="Ivan Rudik" />
    <script src="12-health-dd_files/header-attrs/header-attrs.js"></script>
    <link href="12-health-dd_files/remark-css/default.css" rel="stylesheet" />
    <link href="12-health-dd_files/remark-css/metropolis.css" rel="stylesheet" />
    <link href="12-health-dd_files/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link href="12-health-dd_files/tile-view/tile-view.css" rel="stylesheet" />
    <script src="12-health-dd_files/tile-view/tile-view.js"></script>
    <link href="12-health-dd_files/panelset/panelset.css" rel="stylesheet" />
    <script src="12-health-dd_files/panelset/panelset.js"></script>
    <script src="12-health-dd_files/xaringanExtra-webcam/webcam.js"></script>
    <script id="xaringanExtra-webcam-options" type="application/json">{"width":"200","height":"200","margin":"1em"}</script>
    <link rel="stylesheet" href="my-css.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Lecture 12
## Health // Difference-in-differences
### Ivan Rudik
### AEM 6510

---

exclude: true

```r
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse, xaringanExtra, rlang, patchwork, nycflights13
)
options(htmltools.dir.version = FALSE)
knitr::opts_hooks$set(fig.callout = function(options) {
  if (options$fig.callout) {
    options$echo &lt;- FALSE
  }
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
  options
})
```

<style>.panelset {
  --panel-tab-color-active: red;
}</style>

---

# Roadmap

- How do we estimate a treatment effect when the treated and control groups do not (counterfactually) look the same in the cross-section?
- What is the mortality cost of lead?


---

class: inverse, center, middle
name: dd

# Difference-in-differences

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px width=796px&gt;&lt;/html&gt;

---

# Our comparisons so far

So far we've made two kinds of comparisons to estimate treatment effects:

1. Comparing two groups with random assignment to treatment .hi[(RCT)]
--

2. Comparing two groups where there is a local discontinuity (i.e. discrete change) in policy .hi[(regression discontinuity)]

--

In both of these were are comparing groups in the .hi-blue[cross-section]: there is no concept or time, before and after a policy was enacted, etc

---

# Our comparisons so far

The key assumption for these comparisons is that the treated group would have looked the same as the control group (i.e. had the same outcomes) in the absense of treatment

--

This assumption is often hard to defend&lt;sup&gt;1&lt;/sup&gt;

.footnote[
One way people show that this tends to not be true is to throw in a bunch of extra controls into the regression, if this affects your estimates it indicates there's likely a problem with the assumption.
]

--

Let's try to relax this assumption by exploiting .hi-blue[temporal comparisons] in addition to the cross-sectional comparison

---

# Difference-in-differences

One way to describe our comparisons thus far is as .hi-red[differences]

--

The estimated effect of a policy is simply the difference in mean outcomes between treated and control groups:
`$$math here$$`

--

figure here

---

# Difference-in-differences

Our next method is called .hi-blue[difference-in-differences] (DD)

--

What DD does is take the difference of two comparisons in three steps:
--

1. Take the difference in mean outcomes between treated and control .hi-red[before] treatment
--

2. Take the difference in mean outcomes between treated and control .hi-red[after] treatment
--

3. Take the difference between 1 and 2

--

The name comes from the fact that we are taking the difference (3) between two differences (1 and 2)

---

# Difference-in-differences

Why do we use DD?

--

The identifying assumption required is less strict than for difference approaches

--

.hi[**DD assumption:**] the treatment and control group would have followed .hi-blue[parallel trends] in the absence of treatment
- i.e. the difference in outcomes would have remained constant

--

This is much less stringent than requiring the outcomes to have been the same in the absence of treatment

---

# Difference-in-differences

.hi-red[Example:] Suppose we want to understand the effect of a conservation policy passed in New York on biodiversity

--

Suppose also that:
- The effect of the New York policy is given by .hi[B]
- Each state has it's own fixed determinants of biodiversity (e.g. land cover, average temperature, etc) given by .hi[NY, PA, MA, etc]
- Each period has it's own determinants of biodiversity, common across all states (e.g. federal policy, global climate change) given by .hi[T&lt;sub&gt;0&lt;/sub&gt;, T&lt;sub&gt;1&lt;/sub&gt;], where 0 is years before the policy is passed, and 1 is after

---

# Difference-in-differences

When we observe data on biodiversity we see the combination of all determinants: .hi[B + NY + T], not just .hi[B]

--

We want to find a way to recover **only** .hi[B]

--

There are two ways you could think about trying to estimate .hi[B] using differences:

1. Compare New York to another state after the policy is passed
--

2. Compare New York to itself, before and after the policy is passed

---

# The cross-sectional difference

Let's compare New York to another state, Pennsylvania

--

If we were to do this with differences we would get an estimate of .hi[B] given by: 
&lt;center&gt;
  .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (PA + T&lt;sub&gt;1&lt;/sub&gt;) = B + NY - PA]
&lt;/center&gt;

--

This is not .hi[B]!

--

Why?

---

# The cross-sectional difference

&lt;center&gt;
  .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (PA + T&lt;sub&gt;1&lt;/sub&gt;) = B + NY - PA]
&lt;/center&gt;

There are other determinants of biodiversity that are different across New York and Pennsylvania that are .hi-blue[not] the policy: landcover, urbanization, pollution, etc

--

If we take a simple difference across states, we can't disentangle whether the difference is due to the policy .hi[B] or differences in these other factors .hi[NY - PA]


---

# The time series difference

The next logical thing to try to circumvent this problem is to compare New York to itself, before .hi[NY + T&lt;sub&gt;0&lt;/sub&gt;] and after .hi[B + NY + T&lt;sub&gt;1&lt;/sub&gt;] the policy

--

&lt;center&gt;
  .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (NY + T&lt;sub&gt;0&lt;/sub&gt;) = B + T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;]
&lt;/center&gt;

--

This is not .hi[B]!

--

Why?


---

# The time series difference

&lt;center&gt;
  .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (NY + T&lt;sub&gt;0&lt;/sub&gt;) = B + T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;]
&lt;/center&gt;

There are other determinants of biodiversity that are different before and after the policy that are .hi-blue[not] the New York policy: federal policy changes, trends in urbanization and pollution

--

If we take a simple difference over time, we can't disentangle whether the difference is due to the policy .hi[B] or differences in other factors that are changing over time .hi[T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;]

---

# Difference-in-differences

With DD we .hi-blue[combine] these two differences

--

We take the time series differences for NY and PA, and then difference them:


|              |        After        |           Before           |                                Time Series Difference                               |
|:------------:|:-------------------:|:--------------------------:|:-----------------------------------------------------------------------------------:|
|   New York   | NY + T&lt;sub&gt;1&lt;/sub&gt; |   B + NY + T&lt;sub&gt;0&lt;/sub&gt;   | (B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (B + NY + T&lt;sub&gt;1&lt;/sub&gt;) = .hi[B + T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;] |
| Pennsylvania |  PA + T&lt;sub&gt;1&lt;/sub&gt; |     PA + T&lt;sub&gt;0&lt;/sub&gt;     |  (PA + T&lt;sub&gt;1&lt;/sub&gt;) - (PA + T&lt;sub&gt;0&lt;/sub&gt;) = .hi[T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;]  |
|              |                     | Difference-in-differences: |                .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;) = B      ]                                    |
|              |                     |                            |                                                                                     |

---

# Difference-in-differences


|              |        After        |           Before           |                                Time Series Difference                               |
|:------------:|:-------------------:|:--------------------------:|:-----------------------------------------------------------------------------------:|
|   New York   | NY + T&lt;sub&gt;1&lt;/sub&gt; |   B + NY + T&lt;sub&gt;0&lt;/sub&gt;   | (B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (B + NY + T&lt;sub&gt;1&lt;/sub&gt;) = .hi[B + T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;] |
| Pennsylvania |  PA + T&lt;sub&gt;1&lt;/sub&gt; |     PA + T&lt;sub&gt;0&lt;/sub&gt;     |  (PA + T&lt;sub&gt;1&lt;/sub&gt;) - (PA + T&lt;sub&gt;0&lt;/sub&gt;) = .hi[T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;]  |
|              |                     | Difference-in-differences: |                .hi[(B + NY + T&lt;sub&gt;1&lt;/sub&gt;) - (T&lt;sub&gt;1&lt;/sub&gt; - T&lt;sub&gt;0&lt;/sub&gt;) = B      ]                                    |
|              |                     |                            |                                                                                     |

--

The time series differences lets us control for all fixed determinants (.hi[NY])

--

The cross-sectional difference lets us control for all period-specific determinants common across all states (.hi[T&lt;sub&gt;1&lt;/sub&gt;])

--

Combining these two differences addresses both and lets us recover .hi[B]

---

# Difference-in-differences: to the data

Now lets see how this works in practice

---

class: inverse, center, middle
name: hr2021

# The effect of leaded gasoline on elderly mortality

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px width=796px&gt;&lt;/html&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
